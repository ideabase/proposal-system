{# /templates/proposals/_entry.twig #}

{% extends '_layout' %}

{# set client = user selected entry category #}
{% set client = craft.categories.group('clients').relatedTo(entry).one() %}

{# set contact = first contact listed in client category #}
{% set contact = client.contacts.one() %}

{# set address = first address listed in client category #}
{% set address = client.addresses.one() %}

{% set suffixes = ['I', 'II', 'III', 'IV', 'V', 'VI', 'VII', 'VIII', 'IX', 'X'] %}

{% block content %}

  <div class="proposal-header print-hide">
    <h1>{{ entry.title }}</h1>

    {% if entry.projectId|length %}
      <p><strong>Project ID:</strong> {{ entry.projectId }}</p>
    {% endif %}

    <a class="button" onclick="window.print()" href="">Print</a>
  </div>

  {# start proposal document #}
  <section class="proposal">

    <section class="page page-cover">
      <div class="page-cover-text">
        {# proposal header #}
        <h1>Proposal of Engagement</h1>

        <table>
          <tbody>
            <tr>
              <td><strong>For:</strong></td>
              <td>{{  client.title }}{% if client.organization|length %}&nbsp;&sol;&nbsp;{{  client.organization }}{% endif %}</td>
            </tr>
            <tr>
              {# IMPORTANT: UPDATE 'clients/_category' AS WELL IF YOU CHANGE HOW CONTACT NAMES ARE DISPLAYED #}
              <td><strong>To:</strong></td>
              <td>
                {%- if contact.prefix|length -%}
                  {{-  contact.prefix -}}&nbsp;
                {%- endif -%}
                {{-  contact.firstName -}}&nbsp;
                {{-  contact.lastName -}}
                {%- if contact.suffix|length -%}
                  {%- if contact.suffix|upper in suffixes -%}
                    &nbsp;{{-  contact.suffix -}}&nbsp;
                  {%- else -%}
                    &comma;&nbsp;{{-  contact.suffix -}}&nbsp;
                  {%- endif -%}
                {%- endif -%}
                {%- if contact.contactTitle|length -%}
                  &sol;&nbsp;{{-  contact.contactTitle -}}
                {%- endif -%}
              </td>
            </tr>
            <tr>
              <td><strong>From:</strong></td>
              <td>IdeaBase, a Research-Based Design Agency at Kent State University</td>
            </tr>
            <tr>
              <td><strong>Date:</strong></td>
              <td>{{ entry.date }}</td>
            </td>
          </tbody>
        </table>
      </div>

      <div class="page-cover-logos">
        <img src="{{ ideabaseLogo.image.one().getUrl }}" alt="{{ ideabaseLogo.imageAlt }}"{% if ideabaseLogo.imageTitle|length %} title="{{ ideabaseLogo.imageTitle }}"{% endif %} style="height:100%;">

        {% if entry.projectType.options[1].selected %}
          <img src="{{ glyphixLogo.image.one().getUrl }}" alt="{{ glyphixLogo.imageAlt }}"{% if glyphixLogo.imageTitle|length %} title="{{ glyphixLogo.imageTitle }}"{% endif %}>
        {% endif %}
      </div>
    </section>

    <section class="page">
      <div class="page-logos">
        <img src="{{ ideabaseLogo.image.one().getUrl }}" alt="{{ ideabaseLogo.imageAlt }}"{% if ideabaseLogo.imageTitle|length %} title="{{ ideabaseLogo.imageTitle }}"{% endif %} style="height:100%;">

        {% if entry.projectType.options[1].selected %}
          <img src="{{ glyphixLogo.image.one().getUrl }}" alt="{{ glyphixLogo.imageAlt }}"{% if glyphixLogo.imageTitle|length %} title="{{ glyphixLogo.imageTitle }}"{% endif %}>
        {% endif %}
      </div>

      <p>{{ entry.date }}</p>
      <p>{{ address.address1 }}{% if address.address2 is not empty %}, {{ address.address2 }}{% endif %}<br>{{ address.city }} {{ address.state|upper }} {{ address.zipCode }}</p>

      <br>

      {# thank you note #}
      <p>Thank you for engaging IdeaBase to prepare a quotation for {{ client.title }}, {{ address.address1 }}{% if address.address2 is not empty %}, {{ address.address2 }}{% endif %}, {{ address.city }} {{ address.state|upper }} {{ address.zipCode }}. IdeaBase is an initiative within the College of Communication and Information at Kent State University. This Proposal of Engagement will outline the scope of our engagement and the projected hours and costs associated with its completion.</p>

      {# working with IdeaBase global #}
      {{ proposalWorking.redactor }}

      <br>

      <p>Sincerely,</p>

      <br><br>
      {# TODO: signature #}
      <p>Kristin Dowling</p>
      <p>Director, IdeaBase</p>
    </section>

    <section class="page">
      <div class="page-logos">
        <img src="{{ ideabaseLogo.image.one().getUrl }}" alt="{{ ideabaseLogo.imageAlt }}"{% if ideabaseLogo.imageTitle|length %} title="{{ ideabaseLogo.imageTitle }}"{% endif %} style="height:100%;">

        {% if entry.projectType.options[1].selected %}
          <img src="{{ glyphixLogo.image.one().getUrl }}" alt="{{ glyphixLogo.imageAlt }}"{% if glyphixLogo.imageTitle|length %} title="{{ glyphixLogo.imageTitle }}"{% endif %}>
        {% endif %}
      </div>

      {# project scope #}
      {% if entry.situation|length %}
        <h1>Scope of Work</h1>

        {# extensive project description (situation) #}
        <h3>Situation:</h3>
        {{ entry.situation }}
      {% endif %}
    </section>

    {# check if project elements are separated by phase #}
    {% set phases = false %}
    {% for block in entry.elements.all() if not phases %}
      {% if block.phase|length %}
        {% set phases = true %}
      {% endif %}
    {% endfor %}

    {# initialize variables outside of the logic #}
    {% set totalCost, elementHours = 0, 0 %}

    {# begin phases #}
    {% if phases %}
      {# if there are phases, count the number of phases #}
      {% set phaseCount = 0 %}
      {% for block in entry.elements.all() %}
        {% if block.phase > phaseCount %}
          {% set phaseCount = block.phase %}
        {% endif %}
      {% endfor %}

      {# print a page for each phase #}
      {% for phase in 1..phaseCount %}
        {# IMPORTANT: IF YOU EDIT THIS PAGE, YOU MUST ALSO EDIT THE NON-PHASE PAGE BELOW #}
        <section class="page page-elements">
          <div class="page-logos">
            <img src="{{ ideabaseLogo.image.one().getUrl }}" alt="{{ ideabaseLogo.imageAlt }}"{% if ideabaseLogo.imageTitle|length %} title="{{ ideabaseLogo.imageTitle }}"{% endif %} style="height:100%;">

            {% if entry.projectType.options[1].selected %}
              <img src="{{ glyphixLogo.image.one().getUrl }}" alt="{{ glyphixLogo.imageAlt }}"{% if glyphixLogo.imageTitle|length %} title="{{ glyphixLogo.imageTitle }}"{% endif %}>
            {% endif %}
          </div>

          {# proposed project elements #}
          <h1>Project Elements</h1>

          <h2 class="h2-phase">Phase {{ phase }}</h2>

          {# initialize phase cost outside of loop #}
          {% set phaseCost = 0 %}

          {% for block in entry.elements.all() %}
            {% if block.phase == phase %}
              <h3>{{ block.elementTitle }}</h3>

              {% set elementHours = block.estimatedHours %}
              {% set phaseCost = phaseCost + elementHours * entry.pricePerHour.value %}
              {{ block.description }}
              <table>
                <tr>
                  <td>{{ elementHours }} hours *</td>
                  <td>{{ entry.pricePerHour.value|currency('USD', [], [], true) }}/hour =</td>
                  <td>${{ elementHours * entry.pricePerHour.value }}</td>
                </tr>
              </table>
              {% set totalCost = totalCost + (elementHours * entry.pricePerHour.value) %}
            {% endif %}
          {% endfor %}
          <h3>Phase Subtotal: ${{ phaseCost }}</h3>
        </section>
      {% endfor %}
    {% else %}
      {% for block in entry.elements.all() %}
      {# IMPORTANT: IF YOU EDIT THIS PAGE, YOU MUST ALSO EDIT THE PHASE PAGE ABOVE #}
        <section class="page">
          <div class="page-logos page-elements">
            <img src="{{ ideabaseLogo.image.one().getUrl }}" alt="{{ ideabaseLogo.imageAlt }}"{% if ideabaseLogo.imageTitle|length %} title="{{ ideabaseLogo.imageTitle }}"{% endif %} style="height:100%;">

            {% if entry.projectType.options[1].selected %}
              <img src="{{ glyphixLogo.image.one().getUrl }}" alt="{{ glyphixLogo.imageAlt }}"{% if glyphixLogo.imageTitle|length %} title="{{ glyphixLogo.imageTitle }}"{% endif %}>
            {% endif %}
          </div>

          {# proposed project elements #}
          <h1>Project Elements</h1>

          <h2>{{ block.elementTitle }}</h2>

          {% set elementHours = block.estimatedHours %}
          {{ block.description }}
          <table>
            <tr>
              <td>{{ elementHours }}</td>
              <td>{{ entry.pricePerHour.value|currency('USD', [], [], true) }}</td>
            </tr>
          </table>
          {% set totalCost = totalCost + (elementHours * entry.pricePerHour.value) %}
        </section>
      {% endfor %}
    {% endif %}
    {# end phases #}

    {# summary page #}
    <section class="page">
      <div class="page-logos">
        <img src="{{ ideabaseLogo.image.one().getUrl }}" alt="{{ ideabaseLogo.imageAlt }}"{% if ideabaseLogo.imageTitle|length %} title="{{ ideabaseLogo.imageTitle }}"{% endif %} style="height:100%;">

        {% if entry.projectType.options[1].selected %}
          <img src="{{ glyphixLogo.image.one().getUrl }}" alt="{{ glyphixLogo.imageAlt }}"{% if glyphixLogo.imageTitle|length %} title="{{ glyphixLogo.imageTitle }}"{% endif %}>
        {% endif %}
      </div>

      <h1>Summary</h1>

      {% if entry.timeline|length %}
        <table>
          <thead>
            <tr>
              {% if phases %}
                <th>Phase</th>
              {% endif %}
              <th>Element</th>
              <th>Estimated Time</th>
              <th>Estimated Cost</th>
            </tr>
          </thead>
          <tbody>
            {% for block in entry.elements.all() %}
              <tr>
                {% if phases %}
                  <td>{{ block.phase }}</td>
                {% endif %}
                <td>{{ block.elementTitle }}</td>
                <td>{{ block.estimatedTime }}</td>
                <td>{{ (block.estimatedHours * entry.pricePerHour.value)|currency('USD', [], [], true) }}</td>
              </tr>
            {% endfor %}
          </tbody>
      {% endif %}

      {# display total cost #}
      <table>
        {% if entry.discount|length %}
          <tr>
            <td>{% if entry.elements.all()|length > 1 %}ESTIMATED TOTAL{% else %}ESTIMATED TOTAL ({{ elementHours }} hours at {{ entry.pricePerHour.value|currency('USD', [], [], true) }}/hour){% endif %}</td>
            <td>{{ (totalCost)|currency('USD', [], [], true) }}</td>
          </tr>
          <tr>
            <td>Discount ({{ entry.discount }} hours at {{ entry.pricePerHour.value|currency('USD', [], [], true) }}/hour)</td>
            <td>{{ (entry.discount * entry.pricePerHour.value)|currency('USD', [], [], true) }}
          </tr>
          {% set totalCost = totalCost - (entry.discount * entry.pricePerHour.value) %}
          {% set elementHours = elementHours - entry.discount %}
          <tr>
            <td>{% if entry.elements.all()|length > 1 %}ESTIMATED & DISCOUNTED TOTAL{% else %}ESTIMATED & DISCOUNTED TOTAL ({{ elementHours - entry.discount }} hours at {{ entry.pricePerHour.value|currency('USD', [], [], true) }}/hour){% endif %}</td>
            <td>{{ (totalCost)|currency('USD', [], [], true) }}</td>
          </tr>
        {% else %}
          <tr>
            <td>{% if entry.elements.all()|length > 1 %}ESTIMATED TOTAL{% else %}ESTIMATED TOTAL ({{ elementHours }} hours at {{ entry.pricePerHour.value|currency('USD', [], [], true) }}/hour){% endif %}</td>
            <td>{{ totalCost|currency('USD', [], [], true) }}</td>
          </tr>
        {% endif %}
      </table>

      {# additional costs #}
      {% if entry.additionalCosts|length %}
        <h2>Additional Costs</h2>

        <table>
          {% for row in entry.additionalCosts %}
            <tr>
              <td>{{ row.description }}</td>
              <td>{{ row.estimatedCost }}</td>
            </tr>
          {% endfor %}
        </table>
      {% endif %}

      {# printing costs #}
      {% if entry.printingCosts|length %}
        <p>Please note this estimate includes print coordination only, not actual printing costs.</p>
      {% endif %}

      {# allowance for client revisions #}
      {% if entry.clientRevisions|length %}
        <p>Please note this estimate allows for 2-3 client revisions. If more than 2-3 sets of client revisions are needed, additional hours will be added to the final invoice.</p>
      {% endif %}
    </section>

    {# agreement page #}
    <section class="page">
      <div class="page-logos">
        <img src="{{ ideabaseLogo.image.one().getUrl }}" alt="{{ ideabaseLogo.imageAlt }}"{% if ideabaseLogo.imageTitle|length %} title="{{ ideabaseLogo.imageTitle }}"{% endif %} style="height:100%;">

        {% if entry.projectType.options[1].selected %}
          <img src="{{ glyphixLogo.image.one().getUrl }}" alt="{{ glyphixLogo.imageAlt }}"{% if glyphixLogo.imageTitle|length %} title="{{ glyphixLogo.imageTitle }}"{% endif %}>
        {% endif %}
      </div>

      <h1>Agreement</h1>

      {# proposal agreement global #}
      {{ proposalAgreement.redactor }}

      {# TODO: signature field #}
    </section>

    {# terms page #}
    <section class="page page-terms">
      {# terms and conditions global #}
      {{ proposalTerms.redactor }}
    </section>
  </section>
  {# end proposal #}

{% endblock %}
{# end content block #}
