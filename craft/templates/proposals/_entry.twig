{# /templates/proposals/_entry.twig #}

{% extends '_layout' %}

{% block content %}

  <h1>{{ entry.title }}</h1>

  <p>Project ID: {{ entry.projectId }}</p>

  <article>
    {# set client = user selected entry category #}
    {% set client = craft.categories.relatedTo(entry).one() %}

    {# set contact = first contact listed in client entry #}
    {% set contact = client.contacts.one() %}

    {# set address = first address listed in client entry #}
    {% set address = client.addresses.one() %}

    {% set suffixes = ['I', 'II', 'III', 'IV', 'V', 'VI', 'VII', 'VIII', 'IX', 'X'] %}

    {# TODO: add ideabase logo at top of proposal #}
    {# TODO: checkbox for glyphix logo #}

    {# proposal header #}
    <h1>Proposal of Engagement</h1>

    <div>
      <p>For: <a href="{{  client.url }}" alt="{{  client.title }}">{{  client.title }}{% if client.organization is not empty %}&nbsp;&sol;&nbsp;{{  client.organization }}{% endif %}</a></p>

      {# IMPORTANT: UPDATE 'clients/_category' AS WELL IF YOU CHANGE HOW CONTACT NAMES ARE DISPLAYED #}
      <p>To:&nbsp;
        {%- if contact.prefix is not empty %}
          {{-  contact.prefix -}}&nbsp;
        {%- endif -%}
        {{-  contact.firstName -}}&nbsp;
        {{-  contact.lastName -}}
        {%- if contact.suffix is not empty -%}
          {%- if contact.suffix|upper in suffixes -%}
            &nbsp;{{-  contact.suffix -}}&nbsp;
          {%- else -%}
            &comma;&nbsp;{{-  contact.suffix -}}&nbsp;
          {%- endif -%}
        {%- endif -%}
        {%- if contact.contactTitle is not empty -%}
          &sol;&nbsp;{{-  contact.contactTitle -}}
        {%- endif -%}</p>

      <p>From: IdeaBase, a Research-Based Design Agency at Kent State University</p>

      <p>Date:&nbsp;{{ entry.date }}</p>
    </div>

    {# thank you note #}
    <div>
      {% include 'proposals/_thank_you' %}
    </div>

    {# working with IdeaBase #}
    <div>
      <h2>Working with IdeaBase</h2>

      {% include 'proposals/_working_with_ideabase' %}
    </div>

    {# project scope #}
    <div>
      <h2>Scope of Work</h2>

      {# extensive project description (situation) #}
      <h3>Situation:</h3>
      <div>
        {{ entry.situation }}
      </div>

      {# proposed project elements #}
      <h3>Proposed Project Elements and Associated Estimates:</h3>
      {# set variable to increment total cost as project elements are added #}
      {% set totalCost, singleElementHours, singleElementPrice = 0, 0, 0 %}

      {% for block in entry.elements.all() %}
        {% switch block.type %}

          {% case "custom" %}
            {% set singleElementHours = block.hoursAndCost[0].estimatedHours %}
            {% set singleElementPrice = block.hoursAndCost[0].pricePerHour %}
            {{ block.description }}
            <table>
              <tr>
                <td>{{ block.hoursAndCost[0].estimatedHours }}</td>
                <td>{{ block.hoursAndCost[0].pricePerHour|currency('USD', [], [], true) }}</td>
              </tr>
            </table>

          {% case 'accessibility' %}
            {% set singleElementHours = block.accessibility[0].estimatedHours %}
            {% set singleElementPrice = block.accessibility[0].pricePerHour %}
            <table>
              <tr>
                <td>{{ block.accessibility[0].description }}</td>
                <td>{{ block.accessibility[0].estimatedHours }}</td>
                <td>{{ block.accessibility[0].pricePerHour|currency('USD', [], [], true) }}</td>
              </tr>
            </table>
            {% if entry.elements.all()|length > 1 %}{% set totalCost = totalCost + (block.accessibility[0].estimatedHours * block.accessibility[0].pricePerHour) %}{% endif %}

          {% case 'viewbook' %}
            {% set singleElementHours = block.viewbook[0].estimatedHours %}
            {% set singleElementPrice = block.viewbook[0].pricePerHour %}
            <table>
              <tr>
                <td>{{ block.viewbook[0].description }}</td>
                <td>{{ block.viewbook[0].estimatedHours }}</td>
                <td>{{ block.viewbook[0].pricePerHour|currency('USD', [], [], true) }}</td>
              </tr>
            </table>
            {% if entry.elements.all()|length > 1 %}{% set totalCost = totalCost + (block.viewbook[0].estimatedHours * block.viewbook[0].pricePerHour) %}{% endif %}

        {% endswitch %}
      {% endfor %}

      {# TODO: discounts for total cost #}

      {# display total cost #}
      <table>
        <tr>
          {% if entry.elements.all()|length > 1 %}<td>ESTIMATED TOTAL</td>{% else %}ESTIMATED TOTAL ({{ singleElementHours }} hours at {{ singleElementPrice|currency('USD', [], [], true) }}/hour){% endif %}
          <td>{{ totalCost|currency('USD', [], [], true) }}</td>
        </tr>
      </table>
    </div>

    {# note on client revisions #}
    <div>
      {% include 'proposals/_client_revisions' %}
    </div>

    {# note on printing cost #}
    {% if entry.printingCost|length %}
    <div>
        <p>
          {% include 'proposals/_printing_cost' %}
        </p>
      {% endif %}
    </div>

    {# suggested timeline #}
    {% if entry.timeline is not empty %}
      <div>
        <h2>Suggested Timeline</h2>

        <table>
          {% for row in entry.timeline %}
            <tr>
              <td>{{ row.description }}</td>
              <td>{{ row.time }}</td>
            </tr>
          {% endfor %}
        </table>
      </div>
    {% endif %}

    {# TODO: allowance for client revisions #}
    {# default allow 2-3 client revisions #}

    {# TODO: estimate includes print coordination, not printing costs #}

    {# TODO: signature field #}

    {# terms and conditions #}
    <div>
      <h2>Terms and Conditions</h2>

      {% include 'proposals/_terms' %}
    </div>
  </article>

{% endblock %}
{# end content block #}
